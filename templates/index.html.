<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://code.responsivevoice.org/responsivevoice.js?key=7VfW8M8z"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <style>
        :root { --accent: #52e5ff; }
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; transition: 0.2s; }
        body { background: #000; color: var(--accent); font-family: 'Segoe UI', sans-serif; height: 100vh; overflow: hidden; }
        
        .owner-badge { position: fixed; top: 15px; left: 15px; font-size: 9px; letter-spacing: 2px; border-left: 3px solid var(--accent); padding: 5px 12px; background: rgba(82,229,255,0.05); z-index: 1000; font-weight: bold; }
        
        #chat-flow { height: 100vh; overflow-y: auto; padding: 70px 20px 120px; display: flex; flex-direction: column; gap: 12px; scroll-behavior: smooth; }
        .bubble { padding: 10px 15px; border: 1px solid var(--accent); background: rgba(0,0,0,0.85); font-size: 14px; max-width: 85%; line-height: 1.4; }
        .u-msg { align-self: flex-end; border-radius: 12px 0 12px 12px; border-color: #444; color: #fff; }
        .j-msg { align-self: flex-start; border-radius: 0 12px 12px 12px; box-shadow: 0 0 10px rgba(82,229,255,0.1); }

        #loading-bar { position: fixed; bottom: 85px; left: 0; height: 2px; background: var(--accent); width: 0%; display: none; box-shadow: 0 0 10px var(--accent); }

        .controls { position: fixed; bottom: 20px; left: 0; width: 100%; display: flex; align-items: center; gap: 10px; padding: 0 15px; background: linear-gradient(transparent, #000 30%); }
        .input-box { flex: 1; background: rgba(255,255,255,0.07); border: 1px solid var(--accent); padding: 14px; border-radius: 10px; color: #fff; }
        
        .gear { position: fixed; top: 15px; right: 20px; font-size: 26px; cursor: pointer; z-index: 2000; }
        #sidePanel { position: fixed; right: -320px; width: 310px; height: 100%; background: #0a0a0a; border-left: 2px solid var(--accent); padding: 25px; z-index: 1500; display: flex; flex-direction: column; gap: 15px; }
        .panel-open #sidePanel { right: 0; }
        
        .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px; }
        .btn-main { background: var(--accent); color: #000; }
        .label { font-size: 10px; color: #666; letter-spacing: 1px; }
    </style>
</head>
<body>

<div class="owner-badge" id="dev-badge">CORE DEVELOPER: ANSH KESHARWANI</div>
<div class="gear" onclick="document.body.classList.toggle('panel-open')">‚öôÔ∏è</div>

<div id="sidePanel">
    <h3 id="set-title">SYSTEM SETTINGS</h3>
    
    <div>
        <label class="label" id="lbl-name">DISPLAY NAME</label>
        <input type="text" id="p-name" class="input-box" style="width:100%;" placeholder="Enter name...">
    </div>

    <div>
        <label class="label" id="lbl-lang">SYSTEM LANGUAGE</label>
        <select id="p-lang" onchange="updateSystemLanguage()" class="input-box" style="width:100%;">
            <option value="en">English</option>
            <option value="hi">Hindi</option>
        </select>
    </div>

    <div id="auth-section" style="margin-top: 10px;"></div>
    
    <button onclick="document.body.classList.remove('panel-open')" class="btn btn-main" id="btn-close" style="margin-top: auto;">SAVE & CLOSE</button>
</div>

<div id="chat-flow"></div>
<div id="loading-bar"></div>

<div class="controls">
    <div onclick="startMic()" style="cursor:pointer; font-size: 26px;">üé§</div>
    <input type="text" id="userInput" class="input-box" placeholder="..." onkeypress="if(event.key==='Enter') processQuery(null, false)">
    <button class="btn btn-main" style="width:auto;" onclick="processQuery(null, false)" id="btn-send">SEND</button>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyBkRqBZKbRyMAQQukFXUYPS1Z262aTJux8", authDomain: "jarvis-175a5.firebaseapp.com", projectId: "jarvis-175a5", storageBucket: "jarvis-175a5.firebasestorage.app", messagingSenderId: "884536662070", appId: "1:884536662070:web:e7e209543fc915f9e9e097" };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const langDict = {
        en: { title: "SYSTEM SETTINGS", name: "DISPLAY NAME", lang: "SYSTEM LANGUAGE", close: "SAVE & CLOSE", send: "SEND", placeholder: "Ask Jarvis...", dev: "CORE DEVELOPER: ANSH KESHARWANI", login: "LOGIN WITH GMAIL", logout: "LOGOUT" },
        hi: { title: "‡§∏‡§ø‡§∏‡•ç‡§ü‡§Æ ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏", name: "‡§™‡•ç‡§∞‡§¶‡§∞‡•ç‡§∂‡§ø‡§§ ‡§®‡§æ‡§Æ", lang: "‡§∏‡§ø‡§∏‡•ç‡§ü‡§Æ ‡§ï‡•Ä ‡§≠‡§æ‡§∑‡§æ", close: "‡§∏‡•á‡§µ ‡§î‡§∞ ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç", send: "‡§≠‡•á‡§ú‡•á‡§Ç", placeholder: "‡§ú‡§æ‡§∞‡•ç‡§µ‡§ø‡§∏ ‡§∏‡•á ‡§™‡•Ç‡§õ‡•á‡§Ç...", dev: "‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§°‡•á‡§µ‡§≤‡§™‡§∞: ‡§Ö‡§Ç‡§∂ ‡§ï‡•á‡§∂‡§∞‡§µ‡§æ‡§®‡•Ä", login: "‡§ú‡•Ä‡§Æ‡•á‡§≤ ‡§≤‡•â‡§ó‡§ø‡§®", logout: "‡§≤‡•â‡§ó‡§Ü‡§â‡§ü" }
    };

    let currLang = 'en';

    auth.onAuthStateChanged(user => {
        const authDiv = document.getElementById('auth-section');
        if (user) {
            if(!document.getElementById('p-name').value) document.getElementById('p-name').value = user.displayName;
            authDiv.innerHTML = `<button class="btn" style="background:#200; color:#f66; border:1px solid #411;" onclick="auth.signOut().then(()=>location.reload())">${langDict[currLang].logout}</button>`;
            loadHistory(user.uid);
        } else {
            document.getElementById('p-name').value = "Guest";
            authDiv.innerHTML = `<button class="btn btn-main" onclick="login()">${langDict[currLang].login}</button>`;
        }
    });

    function login() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }

    function updateSystemLanguage() {
        currLang = document.getElementById('p-lang').value;
        const d = langDict[currLang];
        document.getElementById('set-title').innerText = d.title;
        document.getElementById('lbl-name').innerText = d.name;
        document.getElementById('lbl-lang').innerText = d.lang;
        document.getElementById('btn-close').innerText = d.close;
        document.getElementById('btn-send').innerText = d.send;
        document.getElementById('userInput').placeholder = d.placeholder;
        document.getElementById('dev-badge').innerText = d.dev;
    }

    function renderMsg(txt, type) {
        const flow = document.getElementById('chat-flow');
        const user = document.getElementById('p-name').value || "USER";
        const div = document.createElement('div');
        div.className = 'bubble ' + (type === 'u' ? 'u-msg' : 'j-msg');
        div.innerText = (type === 'u' ? user.toUpperCase() : "JARVIS") + ": " + txt;
        flow.appendChild(div);
        flow.scrollTop = flow.scrollHeight;
    }

    async function processQuery(txt, isVoice) {
        const msg = txt || document.getElementById('userInput').value;
        if (!msg) return;
        document.getElementById('userInput').value = '';
        renderMsg(msg, 'u');
        
        const lBar = document.getElementById('loading-bar');
        lBar.style.display = 'block';
        lBar.style.width = '70%';

        try {
            const resp = await fetch('/ask_jarvis', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ msg: msg, userName: document.getElementById('p-name').value, lang: currLang })
            });
            const data = await resp.json();
            
            lBar.style.width = '100%';
            setTimeout(() => { lBar.style.display = 'none'; lBar.style.width = '0'; }, 300);

            renderMsg(data.reply, 'j');
            
            if (auth.currentUser) {
                db.collection("history").add({ uid: auth.currentUser.uid, text: msg, type: 'u', time: firebase.firestore.FieldValue.serverTimestamp() });
                db.collection("history").add({ uid: auth.currentUser.uid, text: data.reply, type: 'j', time: firebase.firestore.FieldValue.serverTimestamp() });
            }

            if (isVoice) responsiveVoice.speak(data.reply, currLang === 'hi' ? "Hindi Female" : "UK English Female");
        } catch (e) { 
            lBar.style.display = 'none';
            renderMsg("Link Slow. Try again.", "j"); 
        }
    }

    function loadHistory(uid) {
        document.getElementById('chat-flow').innerHTML = "";
        db.collection("history").where("uid", "==", uid).orderBy("time", "desc").limit(20).get().then(snap => {
            let docs = [];
            snap.forEach(doc => docs.unshift(doc.data()));
            docs.forEach(d => renderMsg(d.text, d.type));
        });
    }

    function startMic() {
        const rec = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        rec.lang = currLang === 'hi' ? 'hi-IN' : 'en-US';
        rec.onresult = (e) => processQuery(e.results[0][0].transcript, true);
        rec.start();
    }
</script>
</body>
</html> 

